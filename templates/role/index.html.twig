{% extends 'base.html.twig' %}

{% block title %}Role Management{% endblock %}

{% block page_title %}Role Management{% endblock %}

{% block stylesheets %}
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <!-- Team Management CSS for consistent design -->
    <link rel="stylesheet" href="{{ asset('assets/css/team-management.css') }}">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ asset('assets/css/datatables-custom.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/flash-messages.css') }}">
{% endblock %}

{% block javascripts %}
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
    let allUsers = [];

    /**
     * Load users from backend data
     */
    function loadAllUsers() {
        // Get users from Twig template data
        allUsers = [
            {% for user in users %}
            {
                id: {{ user.id }},
                firstName: "{{ user.firstName|escape('js') }}",
                lastName: "{{ user.lastName|escape('js') }}",
                email: "{{ user.email|escape('js') }}",
                role: "{{ user.getActiveRoles()|length > 0 ? user.getActiveRoles()[0]|replace({'ROLE_': ''}) : 'N/A' }}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
    }

    /**
     * Initialize modern dropdown functionality
     */
    function initUserSearchDropdown() {
        const dropdownButton = document.getElementById('userDropdownButton');
        const dropdownMenu = document.getElementById('userDropdown');
        const searchInput = document.getElementById('userSearchInput');
        const userDropdownList = document.getElementById('userDropdownList');
        const selectedUserText = document.getElementById('selectedUserText');
        const hiddenInput = document.getElementById('user_id');
        
        if (!dropdownButton || !dropdownMenu) return;
        
        // Load all users on page load
        loadAllUsers();
        
        // Show/hide dropdown
        dropdownButton.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleDropdown();
        });
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            const query = this.value.trim().toLowerCase();
            filterUsers(query);
        });
        
        // Handle user selection
        userDropdownList.addEventListener('click', function(e) {
            const userOption = e.target.closest('.user-option');
            if (userOption) {
                const userId = userOption.dataset.value;
                const userName = userOption.dataset.name;
                const userEmail = userOption.dataset.email;
                
                selectUser(userId, userName, userEmail);
                closeDropdown();
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.modern-dropdown')) {
                closeDropdown();
            }
        });
        
        // Focus search input when dropdown opens
        function toggleDropdown() {
            if (dropdownMenu.style.display === 'none' || dropdownMenu.style.display === '') {
                dropdownMenu.style.display = 'block';
                populateUsers(); // Show all users initially
                setTimeout(() => searchInput.focus(), 100);
            } else {
                closeDropdown();
            }
        }
        
        function closeDropdown() {
            dropdownMenu.style.display = 'none';
            searchInput.value = ''; // Clear search
        }
        
        // Populate users in dropdown
        function populateUsers() {
            userDropdownList.innerHTML = allUsers.map(user => 
                `<div class="user-option" data-value="${user.id}" data-name="${user.firstName} ${user.lastName}" data-email="${user.email}" data-role="${user.role || 'N/A'}" 
                     style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid #f1f5f9;"
                     onmouseover="this.style.backgroundColor='#f8fafc'" 
                     onmouseout="this.style.backgroundColor='white'">
                    <div class="user-option-content" style="flex: 1;">
                        <div class="user-option-name" style="font-weight: 600; color: #1e293b; font-size: 0.875rem; margin-bottom: 0.125rem;">${user.firstName} ${user.lastName}</div>
                        <div class="user-option-email" style="color: #64748b; font-size: 0.75rem;">${user.email}</div>
                        <div class="user-option-role" style="color: #9ca3af; font-size: 0.7rem; font-style: italic;">Current: ${user.role}</div>
                    </div>
                </div>`
            ).join('');
        }
        
        // Filter users based on search query
        function filterUsers(query) {
            const filteredUsers = allUsers.filter(user => {
                if (!query) return true;
                
                const fullName = `${user.firstName} ${user.lastName}`.toLowerCase();
                const email = user.email.toLowerCase();
                const role = user.role ? user.role.toLowerCase() : '';
                
                return fullName.includes(query) || email.includes(query) || role.includes(query);
            });
            
            userDropdownList.innerHTML = filteredUsers.map(user => 
                `<div class="user-option" data-value="${user.id}" data-name="${user.firstName} ${user.lastName}" data-email="${user.email}" data-role="${user.role || 'N/A'}" 
                     style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid #f1f5f9;"
                     onmouseover="this.style.backgroundColor='#f8fafc'" 
                     onmouseout="this.style.backgroundColor='white'">
                    <div class="user-option-content" style="flex: 1;">
                        <div class="user-option-name" style="font-weight: 600; color: #1e293b; font-size: 0.875rem; margin-bottom: 0.125rem;">${user.firstName} ${user.lastName}</div>
                        <div class="user-option-email" style="color: #64748b; font-size: 0.75rem;">${user.email}</div>
                        <div class="user-option-role" style="color: #9ca3af; font-size: 0.7rem; font-style: italic;">Current: ${user.role}</div>
                    </div>
                </div>`
            ).join('');
        }
        
        // Select user
        function selectUser(userId, userName, userEmail) {
            selectedUserText.textContent = userName;
            selectedUserText.style.color = '#1e293b';
            
            // Set form value
            if (hiddenInput) {
                hiddenInput.value = userId;
            }
        }
    }

    $(document).ready(function() {
        // Initialize user search dropdown
        initUserSearchDropdown();
        
        // Initialize DataTable
        $('#userRolesTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{{ path('app_roles_data') }}",
                type: 'GET'
            },
            columns: [
                { data: 'userName', name: 'userName' },
                { data: 'email', name: 'email' },
                { data: 'roleName', name: 'roleName' },
                { data: 'assignedAt', name: 'assignedAt' },
                { data: 'assignedBy', name: 'assignedBy' },
                { data: 'status', name: 'status' },
                { data: 'actions', name: 'actions', orderable: false, searchable: false }
            ],
            pageLength: 20,
            lengthMenu: [[10, 20, 30, 50], [10, 20, 30, 50]],
            order: [[3, 'desc']], // Sort by Assigned At column
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            responsive: true,
            dom: 'lfrtip', // Include 'l' to show length selector
            scrollX: true,
            autoWidth: false,
            initComplete: function() {
                // Move both info and length selector to pagination div
                var infoSelector = $('.dataTables_info');
                var lengthSelector = $('.dataTables_length');
                
                if (infoSelector.length) {
                    $('.dataTables_paginate').prepend(infoSelector);
                }
                
                if (lengthSelector.length) {
                    $('.dataTables_paginate').append(lengthSelector);
                }
            }
        });
    });
    </script>
{% endblock %}

{% block body %}
    <div class="team-management">
        <!-- Header Section -->
        <div class="team-header">
            <div class="header-content">
                <h1>Role Management</h1>
                <p>Manage user roles and permissions across your organization</p>
            </div>
            <div class="header-actions">
                <!-- Quick role assignment could be added here if needed -->
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="teams-overview">
            <div class="stats-card">
                <div class="stats-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                    </svg>
                </div>
                <div class="stats-content">
                    <h3>{{ users|length }}</h3>
                    <p>Total Users</p>
                </div>
            </div>
            
            <!-- Role Stats -->
            {% for role in roles %}
                <div class="stats-card">
                    <div class="stats-icon">
                        {% if role.code == 'ROLE_ADMIN' %}
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.286-.948z" clip-rule="evenodd"></path>
                            </svg>
                        {% elseif role.code == 'ROLE_SUPERVISOR' %}
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                            </svg>
                        {% elseif role.code == 'ROLE_FACILITATOR' %}
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                            </svg>
                        {% else %}
                            <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                            </svg>
                        {% endif %}
                    </div>
                    <div class="stats-content">
                        {% set roleCount = roleCounts[role.code] ?? 0 %}
                        <h3>{{ roleCount }}</h3>
                        <p>{{ role.name }}</p>
                        {% if roleCount > 0 %}
                            <small class="text-success">{{ roleCount }} active</small>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Main Content Sections -->
        <div class="teams-section">
            
            <!-- Quick Actions -->
            <div class="team-card">
                <div class="table-section-header">
                    <div class="table-title">
                        <h3>Quick Actions</h3>
                        <p>Assign new roles to users</p>
                    </div>
                </div>
                <div class="quick-actions-content">
                    <form method="post" action="{{ path('app_roles_assign') }}" class="role-assignment-form">
                        <input type="hidden" name="_token" value="{{ csrf_token('assign_role') }}">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="userDropdownButton" class="form-label">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 8px;">
                                        <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM15.472 13.472a4 4 0 010 5.656 4 4 0 01-5.656 0l-3.179-3.179c4.686-4.686 4.686-12.284 0-16.97l3.179 3.179a4 4 0 010 5.656z"></path>
                                    </svg>
                                    Select User
                                </label>
                                <div class="modern-dropdown" style="position: relative; width: 100%;">
                                    <button type="button" id="userDropdownButton" class="modern-dropdown-button" 
                                            style="width: 100%; padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 8px; background: white; color: #374151; font-size: 0.875rem; cursor: pointer; transition: all 0.2s ease; outline: none; display: flex; align-items: center; justify-content: space-between;">
                                        <span id="selectedUserText" style="flex: 1; text-align: left; color: #6b7280;">Select a user...</span>
                                        <svg class="dropdown-arrow" width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="transition: transform 0.2s ease; color: #6b7280;">
                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                    <div id="userDropdown" class="modern-dropdown-menu" 
                                         style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); z-index: 9999; margin-top: 0.25rem; max-height: 300px; overflow: hidden;">
                                        <div class="dropdown-search" style="position: relative; padding: 0.75rem; border-bottom: 1px solid #f1f5f9;">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" class="search-icon" 
                                                 style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none;">
                                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                                            </svg>
                                            <input type="text" id="userSearchInput" class="dropdown-search-input" 
                                                   style="width: 100%; padding: 0.5rem 1rem 0.5rem 2.5rem; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.875rem; background: white; outline: none; transition: border-color 0.2s ease;" 
                                                   placeholder="Search users..." autocomplete="off">
                                        </div>
                                        <div id="userDropdownList" class="dropdown-list" style="max-height: 250px; overflow-y: auto;">
                                            <!-- Users will be populated here -->
                                        </div>
                                    </div>
                                    <input type="hidden" id="user_id" name="user_id" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="role_id">Select Role</label>
                                <select name="role_id" id="role_id" class="form-select" required>
                                    <option value="">Choose a role...</option>
                                    {% for role in roles %}
                                        <option value="{{ role.id }}">{{ role.name }} ({{ role.code }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    Assign Role
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>

        <!-- Role Assignments Table -->
        <div class="teams-section">
            <div class="team-card full-width">
                <div class="table-section-header">
                    <div class="table-title">
                        <h3>Current Role Assignments</h3>
                        <p>View and manage all role assignments across your organization</p>
                    </div>
                </div>
                <div class="table-container">
                    <table id="userRolesTable" class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Assigned At</th>
                                <th>Assigned By</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Styles for Role Management -->
    <style>
        .role-assignment-form {
            width: 100%;
            margin: 0;
        }

        .role-assignment-form .form-row {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .role-assignment-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .role-assignment-form .form-group:last-child {
            flex: 0 0 auto;
        }

        .role-assignment-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .role-assignment-form .form-select,
        .role-assignment-form button {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .role-assignment-form button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .role-assignment-form button:hover {
            background: #5a67d8;
        }

        .table-container {
            margin-top: 1rem;
            overflow-x: auto;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .role-code {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .help-text {
            font-size: 0.875rem;
            color: #6b7280;
            font-style: italic;
        }

        .text-success {
            color: #10b981;
            font-size: 0.875rem;
        }

        .table-section-header {
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }

        .table-title h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }

        .table-title p {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .quick-actions-content {
            padding: 1.5rem;
        }

        @media (max-width: 768px) {
            .role-assignment-form .form-row {
                flex-direction: column;
                gap: 1rem;
            }
            
            .role-assignment-form .form-group:last-child {
                flex: 1;
            }
        }
    </style>
{% endblock %}