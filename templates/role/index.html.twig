{% extends 'base.html.twig' %}

{% block title %}Role Management{% endblock %}

{% block page_title %}Role Management{% endblock %}

{% block stylesheets %}
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ asset('assets/css/role-management.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/datatables-custom.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/flash-messages.css') }}">
{% endblock %}

{% block javascripts %}
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
    $(document).ready(function() {
        $('#userRolesTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: "{{ path('app_roles_data') }}",
                type: 'GET'
            },
            columns: [
                { data: 'userName', name: 'userName' },
                { data: 'email', name: 'email' },
                { data: 'roleName', name: 'roleName' },
                { data: 'assignedAt', name: 'assignedAt' },
                { data: 'assignedBy', name: 'assignedBy' },
                { data: 'status', name: 'status' },
                { data: 'actions', name: 'actions', orderable: false, searchable: false }
            ],
            pageLength: 20,
            lengthMenu: [[10, 20, 30, 50], [10, 20, 30, 50]],
            order: [[3, 'desc']], // Sort by Assigned At column
            language: {
                search: "Search:",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            },
            responsive: true,
            dom: 'lfrtip', // Include 'l' to show length selector
            scrollX: true,
            autoWidth: false,
            initComplete: function() {
                // Move both info and length selector to pagination div
                var infoSelector = $('.dataTables_info');
                var lengthSelector = $('.dataTables_length');
                
                if (infoSelector.length) {
                    $('.dataTables_paginate').prepend(infoSelector);
                }
                
                if (lengthSelector.length) {
                    $('.dataTables_paginate').append(lengthSelector);
                }
            }
        });
    });
    </script>
{% endblock %}

{% block body %}
    <div class="role-management">
        <!-- Stats Overview -->
        <div class="stats-container">
            <div class="stats-card total">
                <h3>{{ users|length }}</h3>
                <p>Total Users</p>
            </div>
            
            <!-- Role Stats -->
            {% for role in roles %}
                {% set roleClass = role.code|lower|replace({'_': '-'}) %}
                <div class="stats-card {{ roleClass }}">
                    <h3>{{ roleCounts[role.code] ?? 0 }}</h3>
                    <p>{{ role.name }}</p>
                </div>
            {% endfor %}
        </div>
        
        <!-- Role Assignment Form -->
        <div class="modern-card">
            <div class="modern-card-header">
                <h2>Assign Role to User</h2>
            </div>
            <div class="modern-card-body">
                <form method="post" action="{{ path('app_roles_assign') }}">
                    <input type="hidden" name="_token" value="{{ csrf_token('assign_role') }}">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group-modern">
                                <label for="user_id" class="form-label-modern">Select User</label>
                                <select name="user_id" id="user_id" class="form-select-modern" required>
                                    <option value="">Choose a user...</option>
                                    {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.getFullName() }} ({{ user.email }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group-modern">
                                <label for="role_id" class="form-label-modern">Select Role</label>
                                <select name="role_id" id="role_id" class="form-select-modern" required>
                                    <option value="">Choose a role...</option>
                                    {% for role in roles %}
                                        <option value="{{ role.id }}">{{ role.name }} ({{ role.code }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-col-button">
                            <button type="submit" class="btn-modern btn-primary-modern">
                                Assign Role
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Current Role Assignments -->
        <div class="modern-card">
            <div class="modern-card-header">
                <h2>Current Role Assignments</h2>
            </div>
            <div class="modern-card-body">
                <table id="userRolesTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Assigned At</th>
                            <th>Assigned By</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded via AJAX -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Available Roles -->
        <div class="modern-card">
            <div class="modern-card-header">
                <h2>Available Roles & Permissions</h2>
            </div>
            <div class="modern-card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    {% for role in roles %}
                        <div class="role-card">
                            <h5>{{ role.name }}</h5>
                            <p>{{ role.description }}</p>
                            <p style="margin-bottom: 1rem;">
                                <strong>Code:</strong> {{ role.code }}
                            </p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="permission-count">
                                    {{ role.permissions|length }} Permissions
                                </span>
                                {% if role.isActive %}
                                    <span class="badge-modern badge-success-modern">Active</span>
                                {% else %}
                                    <span class="badge-modern badge-secondary-modern">Inactive</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}