{% extends 'base.html.twig' %}

{% block title %}{{ page_title }} - Retrospective App{% endblock %}

{% block body %}
<div class="analytics-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1>üìä Analytics Dashboard</h1>
            <p>Detailed insights and statistics for your teams</p>
        </div>
           <div class="header-actions">
               <select class="team-filter-select" id="teamFilter">
                   <option value="">All Teams</option>
                   {# Teams will be loaded via JavaScript from user context #}
               </select>
               <select class="period-filter-select" id="periodFilter">
                   <option value="1month">1 Month</option>
                   <option value="3months">3 Months</option>
                   <option value="6months" selected>6 Months</option>
                   <option value="1year">1 Year</option>
               </select>
               <button class="btn btn-secondary" id="refreshAllBtn">
                   <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                       <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                   </svg>
                   Refresh All
               </button>
           </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" id="loadingState">
        <div class="loading-spinner"></div>
        <p>Loading analytics data...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" id="errorState" style="display: none;">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3>Failed to load analytics</h3>
        <p id="errorMessage">Something went wrong while loading the data.</p>
        <button class="btn btn-primary" onclick="loadAnalytics()">Try Again</button>
    </div>

    <!-- Analytics Content -->
    <div class="analytics-content" id="analyticsContent" style="display: none;">
        
        <!-- Overview Cards -->
        <div class="overview-section">
            <h2>üìà Overview</h2>
            <div class="overview-grid">
                <div class="overview-card">
                    <div class="card-icon retrospective">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3 id="totalRetrospectives">-</h3>
                        <p>Total Retrospectives</p>
                        <small id="retrospectiveDetails">-</small>
                    </div>
                </div>

                <div class="overview-card">
                    <div class="card-icon actions">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3 id="totalActions">-</h3>
                        <p>Total Actions</p>
                        <small id="actionDetails">-</small>
                    </div>
                </div>

                <div class="overview-card">
                    <div class="card-icon completion">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3 id="completionRate">-</h3>
                        <p>Completion Rate</p>
                        <small id="completionDetails">-</small>
                    </div>
                </div>

                <div class="overview-card">
                    <div class="card-icon productivity">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path>
                            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path>
                        </svg>
                    </div>
                    <div class="card-content">
                        <h3 id="productivityScore">-</h3>
                        <p>Productivity Score</p>
                        <small id="productivityDetails">-</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <h2>üìä Charts & Trends</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Retrospective Completion Trend</h3>
                    <canvas id="completionTrendChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Action Status Distribution</h3>
                    <canvas id="actionStatusChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Action Category Distribution</h3>
                    <canvas id="categoryDistributionChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Team Performance</h3>
                    <canvas id="teamPerformanceChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Monthly Activity</h3>
                    <canvas id="monthlyActivityChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Category Trend Over Time</h3>
                    <canvas id="categoryTrendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="detailed-stats-section">
            <h2>üìã Detailed Statistics</h2>
            <div class="stats-tabs">
                <button class="tab-btn active" data-tab="retrospectives">Retrospectives</button>
                <button class="tab-btn" data-tab="actions">Actions</button>
                <button class="tab-btn" data-tab="teams">Teams</button>
                <button class="tab-btn" data-tab="productivity">Productivity</button>
            </div>
            
            <div class="tab-content">
                <div class="tab-panel active" id="retrospectives-tab">
                    <div class="stats-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="retrospectivesTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-panel" id="actions-tab">
                    <div class="stats-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                    <th>Trend</th>
                                </tr>
                            </thead>
                            <tbody id="actionsTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-panel" id="teams-tab">
                    <div class="stats-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Team</th>
                                    <th>Retrospectives</th>
                                    <th>Actions</th>
                                    <th>Completion Rate</th>
                                </tr>
                            </thead>
                            <tbody id="teamsTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-panel" id="productivity-tab">
                    <div class="stats-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Metric</th>
                                    <th>Value</th>
                                    <th>Period</th>
                                </tr>
                            </thead>
                            <tbody id="productivityTableBody">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.analytics-dashboard {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
}

.header-content h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
}

.header-content p {
    margin: 0.5rem 0 0 0;
    color: #6b7280;
    font-size: 1.1rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.team-filter-select {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 200px;
    font-weight: 500;
}

.team-filter-select:hover {
    border-color: #cbd5e1;
    background: #f9fafb;
}

.team-filter-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.period-filter-select {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 150px;
    font-weight: 500;
}

.period-filter-select:hover {
    border-color: #cbd5e1;
    background: #f9fafb;
}

.period-filter-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* Loading State */
.loading-state {
    text-align: center;
    padding: 4rem 2rem;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Error State */
.error-state {
    text-align: center;
    padding: 4rem 2rem;
    background: #fef2f2;
    border: 1px solid #fca5a5;
    border-radius: 8px;
    margin: 2rem 0;
}

.error-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.error-state h3 {
    color: #dc2626;
    margin-bottom: 0.5rem;
}

.error-state p {
    color: #7f1d1d;
    margin-bottom: 1.5rem;
}

/* Overview Section */
.overview-section {
    margin-bottom: 3rem;
}

.overview-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1.5rem;
}

.overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.overview-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.overview-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.card-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.card-icon.retrospective {
    background: #dbeafe;
    color: #1d4ed8;
}

.card-icon.actions {
    background: #fef3c7;
    color: #d97706;
}

.card-icon.completion {
    background: #d1fae5;
    color: #047857;
}

.card-icon.productivity {
    background: #e0e7ff;
    color: #6366f1;
}

.card-content h3 {
    margin: 0 0 0.25rem 0;
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
}

.card-content p {
    margin: 0 0 0.25rem 0;
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
}

.card-content small {
    color: #9ca3af;
    font-size: 0.75rem;
}

/* Charts Section */
.charts-section {
    margin-bottom: 3rem;
}

.charts-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1.5rem;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
}

.chart-container {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.chart-container h3 {
    margin: 0 0 1rem 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
}

.chart-container canvas {
    width: 100% !important;
    height: 400px !important;
}

/* Detailed Statistics */
.detailed-stats-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1.5rem;
}

.stats-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.tab-btn {
    background: none;
    border: none;
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    font-weight: 500;
    color: #6b7280;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
}

.tab-btn:hover {
    color: #374151;
}

.tab-btn.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
}

.tab-content {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
}

.tab-panel {
    display: none;
    padding: 1.5rem;
}

.tab-panel.active {
    display: block;
}

.stats-table {
    overflow-x: auto;
}

.stats-table table {
    width: 100%;
    border-collapse: collapse;
}

.stats-table th,
.stats-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}

.stats-table th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
}

.stats-table td {
    color: #6b7280;
}

/* Responsive */
@media (max-width: 768px) {
    .analytics-dashboard {
        padding: 1rem;
    }
    
    .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .overview-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-tabs {
        flex-wrap: wrap;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

document.addEventListener('DOMContentLoaded', function() {
    loadUserTeams();
    loadAnalytics();
    
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            switchTab(tabName);
        });
    });
    
    // Refresh button
    document.getElementById('refreshAllBtn').addEventListener('click', function() {
        loadAnalytics(true);
    });
    
    // Team filter change
    const teamFilter = document.getElementById('teamFilter');
    if (teamFilter) {
        teamFilter.addEventListener('change', function() {
            loadAnalytics(true);
        });
    }
    
    // Period filter change
    const periodFilter = document.getElementById('periodFilter');
    if (periodFilter) {
        periodFilter.addEventListener('change', function() {
            loadAnalytics(true);
        });
    }
});

function loadUserTeams() {
    // Fetch user's teams to populate dropdown
    fetch('/statistics/teams', { credentials: 'include' })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.data && Array.isArray(data.data)) {
            const teamFilter = document.getElementById('teamFilter');
            data.data.forEach(team => {
                const option = document.createElement('option');
                option.value = team.team_id;
                option.textContent = team.team_name;
                teamFilter.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Error loading teams:', error);
    });
}

function loadAnalytics(showLoading = false) {
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const analyticsContent = document.getElementById('analyticsContent');
    const teamFilter = document.getElementById('teamFilter');
    
    if (showLoading) {
        loadingState.style.display = 'block';
        errorState.style.display = 'none';
        analyticsContent.style.display = 'none';
    }
    
    // Get selected team ID and period
    const teamId = teamFilter ? teamFilter.value : '';
    const period = periodFilter ? periodFilter.value : '6months';
    
    // Build query parameters
    const params = new URLSearchParams();
    if (teamId) params.append('teamId', teamId);
    params.append('period', period);
    const queryString = params.toString();
    const paramString = queryString ? `?${queryString}` : '';
    
    // Load all analytics data
    Promise.all([
        fetch(`/statistics/retrospectives${paramString}`, { credentials: 'include' }).then(r => r.json()),
        fetch(`/statistics/actions${paramString}`, { credentials: 'include' }).then(r => r.json()),
        fetch(`/statistics/teams${paramString}`, { credentials: 'include' }).then(r => r.json()),
        fetch(`/statistics/completion-trend${paramString}`, { credentials: 'include' }).then(r => r.json()),
        fetch(`/statistics/monthly-activity${paramString}`, { credentials: 'include' }).then(r => r.json()),
        fetch(`/statistics/category-distribution${paramString}`, { credentials: 'include' }).then(r => r.json()),
        fetch(`/statistics/category-trend${paramString}`, { credentials: 'include' }).then(r => r.json())
    ])
    .then(([retrospectivesData, actionsData, teamsData, trendData, activityData, categoryData, categoryTrendData]) => {
        // Check if all responses are successful
        if (retrospectivesData.success && actionsData.success && teamsData.success && trendData.success && activityData.success && categoryData.success && categoryTrendData.success) {
            updateOverviewCards(retrospectivesData.data, actionsData.data);
            updateDetailedTables(retrospectivesData.data, actionsData.data, teamsData.data);
            initializeCharts(retrospectivesData.data, actionsData.data, teamsData.data, trendData.data, activityData.data, categoryData.data, categoryTrendData.data);
            
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            analyticsContent.style.display = 'block';
        } else {
            throw new Error('Failed to load analytics data');
        }
    })
    .catch(error => {
        console.error('Error loading analytics:', error);
        loadingState.style.display = 'none';
        errorState.style.display = 'block';
        analyticsContent.style.display = 'none';
        document.getElementById('errorMessage').textContent = error.message;
    });
}

function updateOverviewCards(retrospectivesData, actionsData) {
    // Update overview cards with data - data comes directly
    const retroData = retrospectivesData || {};
    const actionData = actionsData || {};
    
    document.getElementById('totalRetrospectives').textContent = retroData.total_retrospectives || 0;
    document.getElementById('retrospectiveDetails').textContent = 
        `${retroData.active_retrospectives || 0} active, ${retroData.completed_retrospectives || 0} completed`;
    
    document.getElementById('totalActions').textContent = actionData.total_actions || 0;
    document.getElementById('actionDetails').textContent = 
        `${actionData.pending_actions || 0} pending, ${actionData.completed_actions || 0} completed`;
    
    document.getElementById('completionRate').textContent = (retroData.completion_rate || 0) + '%';
    document.getElementById('completionDetails').textContent = 
        `Avg duration: ${retroData.average_duration_formatted || 'N/A'}`;
    
    document.getElementById('productivityScore').textContent = (actionData.velocity_actions_per_week || 0) + '/week';
    document.getElementById('productivityDetails').textContent = 
        `${actionData.actions_completed_last_30_days || 0} completed last 30 days`;
}

function updateDetailedTables(retrospectivesData, actionsData, teamsData) {
    // Update retrospectives table - data comes directly
    const retroData = retrospectivesData || {};
    const actionData = actionsData || {};
    
    const retroTbody = document.getElementById('retrospectivesTableBody');
    retroTbody.innerHTML = `
        <tr><td>Total Retrospectives</td><td>${retroData.total_retrospectives || 0}</td><td>-</td></tr>
        <tr><td>Completed</td><td>${retroData.completed_retrospectives || 0}</td><td>-</td></tr>
        <tr><td>Active</td><td>${retroData.active_retrospectives || 0}</td><td>-</td></tr>
        <tr><td>Planned</td><td>${retroData.planned_retrospectives || 0}</td><td>-</td></tr>
        <tr><td>Completion Rate</td><td>${retroData.completion_rate || 0}%</td><td>-</td></tr>
        <tr><td>Average Duration</td><td>${retroData.average_duration_formatted || 'N/A'}</td><td>-</td></tr>
    `;
    
    // Update actions table
    const actionsTbody = document.getElementById('actionsTableBody');
    actionsTbody.innerHTML = `
        <tr><td>Total Actions</td><td>${actionData.total_actions || 0}</td><td>-</td></tr>
        <tr><td>Pending</td><td>${actionData.pending_actions || 0}</td><td>-</td></tr>
        <tr><td>In Progress</td><td>${actionData.in_progress_actions || 0}</td><td>-</td></tr>
        <tr><td>Completed</td><td>${actionData.completed_actions || 0}</td><td>-</td></tr>
        <tr><td>Overdue</td><td>${actionData.overdue_actions || 0}</td><td>-</td></tr>
        <tr><td>Completion Rate</td><td>${actionData.completion_rate || 0}%</td><td>-</td></tr>
    `;
    
    // Update teams table
    const teamsTbody = document.getElementById('teamsTableBody');
    if (teamsData.data && Array.isArray(teamsData.data)) {
        teamsTbody.innerHTML = teamsData.data.map(team => `
            <tr>
                <td>${team.team_name}</td>
                <td>${team.retrospectives?.total || 0}</td>
                <td>-</td>
                <td>${team.retrospectives?.completion_rate || 0}%</td>
            </tr>
        `).join('');
    } else {
        teamsTbody.innerHTML = '<tr><td colspan="4">No team data available</td></tr>';
    }
    
    // Update productivity table
    const productivityTbody = document.getElementById('productivityTableBody');
    productivityTbody.innerHTML = `
        <tr><td>Actions Created (30 days)</td><td>${actionData.actions_created_last_30_days || 0}</td><td>Last 30 days</td></tr>
        <tr><td>Actions Completed (30 days)</td><td>${actionData.actions_completed_last_30_days || 0}</td><td>Last 30 days</td></tr>
        <tr><td>Velocity</td><td>${actionData.velocity_actions_per_week || 0} actions/week</td><td>Current</td></tr>
        <tr><td>Productivity Trend</td><td>${actionData.productivity_trend || 'stable'}</td><td>vs Previous</td></tr>
    `;
}

function initializeCharts(retrospectivesData, actionsData, teamsData, trendData, activityData, categoryData, categoryTrendData) {
    // Initialize Chart.js charts
    initializeCompletionTrendChart(trendData);
    initializeActionStatusChart(actionsData);
    initializeCategoryDistributionChart(categoryData);
    initializeTeamPerformanceChart(teamsData);
    initializeMonthlyActivityChart(activityData);
    initializeCategoryTrendChart(categoryTrendData);
}

function initializeCompletionTrendChart(data) {
    const ctx = document.getElementById('completionTrendChart').getContext('2d');
    
    if (charts.completionTrend) {
        charts.completionTrend.destroy();
    }
    
    // Use real data from API
    const months = data?.months || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const completedData = data?.completed || [0, 0, 0, 0, 0, 0];
    const plannedData = data?.planned || [0, 0, 0, 0, 0, 0];
    
    charts.completionTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Completed',
                data: completedData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }, {
                label: 'Planned',
                data: plannedData,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initializeActionStatusChart(data) {
    const ctx = document.getElementById('actionStatusChart').getContext('2d');
    
    if (charts.actionStatus) {
        charts.actionStatus.destroy();
    }
    
    // Data comes directly, not nested in 'basic'
    const actionData = data || {};
    
    charts.actionStatus = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending', 'In Progress', 'Overdue'],
            datasets: [{
                data: [
                    actionData.completed_actions || 0,
                    actionData.pending_actions || 0,
                    actionData.in_progress_actions || 0,
                    actionData.overdue_actions || 0
                ],
                backgroundColor: [
                    '#10b981',
                    '#f59e0b',
                    '#3b82f6',
                    '#ef4444'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
}

function initializeCategoryDistributionChart(data) {
    const ctx = document.getElementById('categoryDistributionChart').getContext('2d');
    
    if (charts.categoryDistribution) {
        charts.categoryDistribution.destroy();
    }
    
    // Extract labels and values from category data
    const categoryLabels = Object.keys(data || {});
    const categoryValues = Object.values(data || {});
    
    charts.categoryDistribution = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: categoryLabels.length > 0 ? categoryLabels : ['No Data'],
            datasets: [{
                data: categoryValues.length > 0 ? categoryValues : [1],
                backgroundColor: [
                    '#f87171', // More vibrant red - What went wrong
                    '#4ade80', // More vibrant green - What went good  
                    '#fbbf24', // More vibrant yellow - What can be improved
                    '#a78bfa', // More vibrant purple - Random feedback
                    '#8b5cf6', // Purple - Extra
                    '#ec4899'  // Pink - Extra
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function initializeTeamPerformanceChart(data) {
    const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
    
    if (charts.teamPerformance) {
        charts.teamPerformance.destroy();
    }
    
    const teamNames = data.data && Array.isArray(data.data) ? data.data.map(team => team.team_name) : ['No Teams'];
    const completionRates = data.data && Array.isArray(data.data) ? data.data.map(team => team.retrospectives.completion_rate || 0) : [0];
    
    charts.teamPerformance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: teamNames,
            datasets: [{
                label: 'Completion Rate (%)',
                data: completionRates,
                backgroundColor: '#3b82f6',
                borderColor: '#1d4ed8',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

function initializeMonthlyActivityChart(data) {
    const ctx = document.getElementById('monthlyActivityChart').getContext('2d');
    
    if (charts.monthlyActivity) {
        charts.monthlyActivity.destroy();
    }
    
    // Use real data from API
    const months = data?.months || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const createdData = data?.created || [0, 0, 0, 0, 0, 0];
    const completedData = data?.completed || [0, 0, 0, 0, 0, 0];
    
    charts.monthlyActivity = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Actions Created',
                data: createdData,
                backgroundColor: '#8b5cf6',
                borderColor: '#7c3aed',
                borderWidth: 1
            }, {
                label: 'Actions Completed',
                data: completedData,
                backgroundColor: '#06b6d4',
                borderColor: '#0891b2',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function initializeCategoryTrendChart(data) {
    const ctx = document.getElementById('categoryTrendChart').getContext('2d');
    
    if (charts.categoryTrend) {
        charts.categoryTrend.destroy();
    }
    
    const months = data?.months || [];
    const categories = data?.categories || {};
    
    // Prepare datasets for each category
    const datasets = [];
    const colors = [
        { border: '#f87171', background: 'rgba(248, 113, 113, 0.1)' }, // Red - What went wrong
        { border: '#4ade80', background: 'rgba(74, 222, 128, 0.1)' }, // Green - What went good
        { border: '#fbbf24', background: 'rgba(251, 191, 36, 0.1)' }, // Yellow - What can be improved
        { border: '#a78bfa', background: 'rgba(167, 139, 250, 0.1)' }  // Purple - Random feedback
    ];
    
    let colorIndex = 0;
    for (const [categoryName, categoryData] of Object.entries(categories)) {
        const values = months.map(month => categoryData[month] || 0);
        const color = colors[colorIndex % colors.length];
        
        datasets.push({
            label: categoryName,
            data: values,
            borderColor: color.border,
            backgroundColor: color.background,
            tension: 0.4,
            fill: false
        });
        
        colorIndex++;
    }
    
    charts.categoryTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Items'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

function switchTab(tabName) {
    // Hide all tab panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab panel
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Add active class to selected tab button
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
}
</script>
{% endblock %}
