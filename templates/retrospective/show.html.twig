{% extends 'base.html.twig' %}

{% block title %}{{ retrospective.title }}{% endblock %}

{% block page_title %}{{ retrospective.title }}{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css/retrospective.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/retrospective-board.css') }}">
    <link rel="stylesheet" href="{{ asset('assets/css/discussion-phase.css') }}">
{% endblock %}

{% block head %}
    {# Generate a unique CSRF token for this retrospective session #}
    {% set csrfToken = csrf_token('retrospective_action') %}
    <meta name="csrf-token" content="{{ csrfToken }}">
    <meta name="csrf-token-add-item" content="{{ csrfToken }}">
    <meta name="csrf-token-reorder" content="{{ csrfToken }}">
    <meta name="csrf-token-separate" content="{{ csrfToken }}">
{% endblock %}

{% block body %}
    <div class="retrospective-management">
        <!-- Header Section -->
        <div class="retrospective-header">
            <div class="header-content">
                <h1>{{ retrospective.title }}</h1>
                <p>{{ retrospective.team.name }} • Step: {{ retrospective.currentStep|title }}</p>
            </div>
            <div class="header-actions">
                <span class="status-badge {{ retrospective.status }}">
                    {{ retrospective.status|title }}
                </span>
                
                {% if retrospective.facilitator == app.user and retrospective.isActive() %}
                    {% if retrospective.currentStep != 'completed' %}
                        <button id="nextStepBtn" class="btn btn-warning">
                            Next Step
                        </button>
                    {% endif %}
                {% endif %}
                
                <a href="{{ path('app_retrospectives') }}" class="btn btn-secondary">
                    Back to Retrospectives
                </a>
            </div>
        </div>

        <!-- DEBUG: isActive: {{ retrospective.isActive() ? 'true' : 'false' }}, currentStep: {{ retrospective.currentStep }}, isInStep('feedback'): {{ retrospective.isInStep('feedback') ? 'true' : 'false' }}, isInStep('review'): {{ retrospective.isInStep('review') ? 'true' : 'false' }} -->
        {% if retrospective.isActive() and retrospective.isInStep('feedback') %}
        <!-- Interactive Retrospective Board -->
        <div class="retrospective-board">

            <!-- Feedback Columns -->
            <div class="feedback-columns">
                <div class="feedback-column" data-category="wrong">
                    <div class="column-header wrong">
                        <h3>What went wrong</h3>
                        <span class="item-count">{{ wrongItems|length }}</span>
                    </div>
                    
                    <div class="add-item-form" style="display: none;">
                        <textarea placeholder="Add your feedback..." data-category="wrong" class="item-input"></textarea>
                        <button class="add-item-btn" data-category="wrong">Add</button>
                    </div>
                    
                    <div class="items-container" id="wrongItems">
                        {% for item in wrongItems %}
                        <div class="post-it wrong" data-item-id="{{ item.id }}">
                            <div class="post-it-content">{{ item.content }}</div>
                            <div class="post-it-delete">×</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="feedback-column" data-category="good">
                    <div class="column-header good">
                        <h3>What went good</h3>
                        <span class="item-count">{{ goodItems|length }}</span>
                    </div>
                    
                    <div class="add-item-form" style="display: none;">
                        <textarea placeholder="Add your feedback..." data-category="good" class="item-input"></textarea>
                        <button class="add-item-btn" data-category="good">Add</button>
                    </div>
                    
                    <div class="items-container" id="goodItems">
                        {% for item in goodItems %}
                        <div class="post-it good" data-item-id="{{ item.id }}">
                            <div class="post-it-content">{{ item.content }}</div>
                            <div class="post-it-delete">×</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="feedback-column" data-category="improved">
                    <div class="column-header improved">
                        <h3>What can be improved</h3>
                        <span class="item-count">{{ improvedItems|length }}</span>
                    </div>
                    
                    <div class="add-item-form" style="display: none;">
                        <textarea placeholder="Add your feedback..." data-category="improved" class="item-input"></textarea>
                        <button class="add-item-btn" data-category="improved">Add</button>
                    </div>
                    
                    <div class="items-container" id="improvedItems">
                        {% for item in improvedItems %}
                        <div class="post-it improved" data-item-id="{{ item.id }}">
                            <div class="post-it-content">{{ item.content }}</div>
                            <div class="post-it-delete">×</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="feedback-column" data-category="random">
                    <div class="column-header random">
                        <h3>Random feedback</h3>
                        <span class="item-count">{{ randomItems|length }}</span>
                    </div>
                    
                    <div class="add-item-form" style="display: none;">
                        <textarea placeholder="Add your feedback..." data-category="random" class="item-input"></textarea>
                        <button class="add-item-btn" data-category="random">Add</button>
                    </div>
                    
                    <div class="items-container" id="randomItems">
                        {% for item in randomItems %}
                        <div class="post-it random" data-item-id="{{ item.id }}">
                            <div class="post-it-content">{{ item.content }}</div>
                            <div class="post-it-delete">×</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {% elseif retrospective.isActive() and retrospective.isInStep('review') %}
        <!-- Review Phase -->
        <div class="review-phase">
            <div class="review-header">
                <h2>Review & Group Similar Items</h2>
                <p>Drag and drop similar items within columns to create groups</p>
            </div>
            
            <!-- Review Columns -->
            <div class="feedback-columns review-columns">
                <div class="feedback-column" data-category="wrong">
                    <div class="column-header wrong">
                        <h3>What went wrong</h3>
                        <span class="item-count" id="wrongCount">0</span>
                    </div>
                    <div class="items-container review-container" id="wrongItems">
                        <!-- Items will be loaded here via JavaScript -->
                    </div>
                </div>

                <div class="feedback-column" data-category="good">
                    <div class="column-header good">
                        <h3>What went good</h3>
                        <span class="item-count" id="goodCount">0</span>
                    </div>
                    <div class="items-container review-container" id="goodItems">
                        <!-- Items will be loaded here via JavaScript -->
                    </div>
                </div>

                <div class="feedback-column" data-category="improved">
                    <div class="column-header improved">
                        <h3>What can be improved</h3>
                        <span class="item-count" id="improvedCount">0</span>
                    </div>
                    <div class="items-container review-container" id="improvedItems">
                        <!-- Items will be loaded here via JavaScript -->
                    </div>
                </div>

                <div class="feedback-column" data-category="random">
                    <div class="column-header random">
                        <h3>Random feedback</h3>
                        <span class="item-count" id="randomCount">0</span>
                    </div>
                    <div class="items-container review-container" id="randomItems">
                        <!-- Items will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        {% elseif retrospective.isActive() and retrospective.isInStep('voting') %}
        <!-- Voting Phase -->
        <div class="voting-phase">
            <div class="review-header">
                <h2>Voting Phase</h2>
                <p>Vote on the most important items to discuss</p>
            </div>
            
            <div class="feedback-columns readonly">
                <div class="feedback-column">
                    <div class="column-header wrong">
                        <h3>What went wrong</h3>
                        <span class="item-count">{{ wrongCombined|length }}</span>
                    </div>
                    <div class="items-container">
                        {% for element in wrongCombined %}
                            {% if element.type == 'item' %}
                                {% set item = element.entity %}
                                <div class="post-it wrong readonly" data-item-id="{{ item.id }}">
                                    <div class="post-it-content">{{ item.content }}</div>
                                    <div class="post-it-meta">
                                        <span class="votes" data-item-id="{{ item.id }}">0 votes</span>
                                    </div>
                                    <div class="voting-controls" style="display: none;">
                                        <button class="vote-btn vote-decrease" data-item-id="{{ item.id }}" data-action="decrease">-</button>
                                        <input type="number" class="vote-input" data-item-id="{{ item.id }}" value="0" readonly min="0" max="2">
                                        <button class="vote-btn vote-increase" data-item-id="{{ item.id }}" data-action="increase">+</button>
                                    </div>
                                </div>
                            {% else %}
                                {% set group = element.entity %}
                                <div class="post-it wrong readonly combined-group" data-group-id="{{ group.id }}">
                                    <div class="post-it-content">
                                        {% for groupItem in group.items %}
                                            <div class="item-paragraph">{{ groupItem.content }}</div>
                                            {% if not loop.last %}
                                                <div class="item-separator"></div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="post-it-meta">
                                        <span class="votes" data-group-id="{{ group.id }}">0 votes</span>
                                    </div>
                                    <div class="voting-controls" style="display: none;">
                                        <button class="vote-btn vote-decrease" data-group-id="{{ group.id }}" data-action="decrease">-</button>
                                        <input type="number" class="vote-input" data-group-id="{{ group.id }}" value="0" readonly min="0" max="2">
                                        <button class="vote-btn vote-increase" data-group-id="{{ group.id }}" data-action="increase">+</button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="feedback-column">
                    <div class="column-header good">
                        <h3>What went good</h3>
                        <span class="item-count">{{ goodCombined|length }}</span>
                    </div>
                    <div class="items-container">
                        {% for element in goodCombined %}
                            {% if element.type == 'item' %}
                                {% set item = element.entity %}
                                <div class="post-it good readonly" data-item-id="{{ item.id }}">
                                    <div class="post-it-content">{{ item.content }}</div>
                                    <div class="post-it-meta">
                                        <span class="votes" data-item-id="{{ item.id }}">0 votes</span>
                                    </div>
                                    <div class="voting-controls" style="display: none;">
                                        <button class="vote-btn vote-decrease" data-item-id="{{ item.id }}" data-action="decrease">-</button>
                                        <input type="number" class="vote-input" data-item-id="{{ item.id }}" value="0" readonly min="0" max="2">
                                        <button class="vote-btn vote-increase" data-item-id="{{ item.id }}" data-action="increase">+</button>
                                    </div>
                                </div>
                            {% else %}
                                {% set group = element.entity %}
                                <div class="post-it good readonly combined-group" data-group-id="{{ group.id }}">
                                    <div class="post-it-content">
                                        {% for groupItem in group.items %}
                                            <div class="item-paragraph">{{ groupItem.content }}</div>
                                            {% if not loop.last %}
                                                <div class="item-separator"></div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="post-it-meta">
                                        <span class="votes" data-group-id="{{ group.id }}">0 votes</span>
                                    </div>
                                    <div class="voting-controls" style="display: none;">
                                        <button class="vote-btn vote-decrease" data-group-id="{{ group.id }}" data-action="decrease">-</button>
                                        <input type="number" class="vote-input" data-group-id="{{ group.id }}" value="0" readonly min="0" max="2">
                                        <button class="vote-btn vote-increase" data-group-id="{{ group.id }}" data-action="increase">+</button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="feedback-column">
                    <div class="column-header improved">
                        <h3>What can be improved</h3>
                        <span class="item-count">{{ improvedCombined|length }}</span>
                    </div>
                    <div class="items-container">
                        {% for element in improvedCombined %}
                            {% if element.type == 'item' %}
                                {% set item = element.entity %}
                                <div class="post-it improved readonly" data-item-id="{{ item.id }}">
                                    <div class="post-it-content">{{ item.content }}</div>
                                    <div class="post-it-meta">
                                        <span class="votes" data-item-id="{{ item.id }}">0 votes</span>
                                    </div>
                                    <div class="voting-controls" style="display: none;">
                                        <button class="vote-btn vote-decrease" data-item-id="{{ item.id }}" data-action="decrease">-</button>
                                        <input type="number" class="vote-input" data-item-id="{{ item.id }}" value="0" readonly min="0" max="2">
                                        <button class="vote-btn vote-increase" data-item-id="{{ item.id }}" data-action="increase">+</button>
                                    </div>
                                </div>
                            {% else %}
                                {% set group = element.entity %}
                                <div class="post-it improved readonly combined-group" data-group-id="{{ group.id }}">
                                    <div class="post-it-content">
                                        {% for groupItem in group.items %}
                                            <div class="item-paragraph">{{ groupItem.content }}</div>
                                            {% if not loop.last %}
                                                <div class="item-separator"></div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="post-it-meta">
                                        <span class="votes" data-group-id="{{ group.id }}">0 votes</span>
                                    </div>
                                    <div class="voting-controls" style="display: none;">
                                        <button class="vote-btn vote-decrease" data-group-id="{{ group.id }}" data-action="decrease">-</button>
                                        <input type="number" class="vote-input" data-group-id="{{ group.id }}" value="0" readonly min="0" max="2">
                                        <button class="vote-btn vote-increase" data-group-id="{{ group.id }}" data-action="increase">+</button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <div class="feedback-column">
                    <div class="column-header random">
                        <h3>Random feedback</h3>
                        <span class="item-count">{{ randomCombined|length }}</span>
                    </div>
                    <div class="items-container">
                        {% for element in randomCombined %}
                            {% if element.type == 'item' %}
                                {% set item = element.entity %}
                                <div class="post-it random readonly" data-item-id="{{ item.id }}">
                                    <div class="post-it-content">{{ item.content }}</div>
                                    <div class="post-it-meta">
                                        <span class="votes" data-item-id="{{ item.id }}">0 votes</span>
                                    </div>
                                    <div class="voting-controls" style="display: none;">
                                        <button class="vote-btn vote-decrease" data-item-id="{{ item.id }}" data-action="decrease">-</button>
                                        <input type="number" class="vote-input" data-item-id="{{ item.id }}" value="0" readonly min="0" max="2">
                                        <button class="vote-btn vote-increase" data-item-id="{{ item.id }}" data-action="increase">+</button>
                                    </div>
                                </div>
                            {% else %}
                                {% set group = element.entity %}
                                <div class="post-it random readonly combined-group" data-group-id="{{ group.id }}">
                                    <div class="post-it-content">
                                        {% for groupItem in group.items %}
                                            <div class="item-paragraph">{{ groupItem.content }}</div>
                                            {% if not loop.last %}
                                                <div class="item-separator"></div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="post-it-meta">
                                        <span class="votes" data-group-id="{{ group.id }}">0 votes</span>
                                    </div>
                                    <div class="voting-controls" style="display: none;">
                                        <button class="vote-btn vote-decrease" data-group-id="{{ group.id }}" data-action="decrease">-</button>
                                        <input type="number" class="vote-input" data-group-id="{{ group.id }}" value="0" readonly min="0" max="2">
                                        <button class="vote-btn vote-increase" data-group-id="{{ group.id }}" data-action="increase">+</button>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {% elseif retrospective.isActive() and retrospective.isInStep('actions') %}
        <!-- Action Phase -->
        <div class="actions-phase">
            <div class="review-header">
                <h2>Action Phase</h2>
                <p>Review items sorted by votes and create action items</p>
            </div>
            
            <div class="discussion-container">
                {% if sortedItemsWithVotes|length > 0 %}
                    {% for element in sortedItemsWithVotes %}
                        {% if element.type == 'item' %}
                            {% set item = element.entity %}
                            <div class="discussion-card {{ element.category }}">
                                <div class="category-indicator {{ element.category }}"></div>
                                <div class="card-content">
                                    <div class="card-text">{{ item.content }}</div>
                                    <div class="card-footer">
                                        <span class="total-votes">{{ element.totalVotes }} {{ element.totalVotes == 1 ? 'vote' : 'votes' }}</span>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            {% set group = element.entity %}
                            <div class="discussion-card {{ element.category }} combined-group">
                                <div class="category-indicator {{ element.category }}"></div>
                                <div class="card-content">
                                    <div class="card-text">
                                        {% for groupItem in group.items %}
                                            <div class="item-paragraph">{{ groupItem.content }}</div>
                                            {% if not loop.last %}
                                                <div class="item-separator"></div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <div class="card-footer">
                                        <span class="group-count">{{ group.items|length }} items</span>
                                        <span class="total-votes">{{ element.totalVotes }} {{ element.totalVotes == 1 ? 'vote' : 'votes' }}</span>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <p class="no-items">No items to discuss yet.</p>
                {% endif %}
            </div>

            {% if retrospective.facilitator == app.user or retrospective.team.owner == app.user %}
            <div class="add-action-section" style="margin-top: 2rem;">
                <a href="{{ path('app_retrospectives_add_action', {'id': retrospective.id}) }}" class="btn btn-primary">
                    Add Action Item
                </a>
            </div>
            {% endif %}

            {% if actions|length > 0 %}
            <div class="actions-list" style="margin-top: 2rem;">
                <h3>Action Items</h3>
                {% for action in actions %}
                <div class="action-item">
                    <div class="action-content">
                        <h4>{{ action.description }}</h4>
                        <div class="action-details">
                            <span class="assigned-to">Assigned to: {{ action.assignedTo.firstName }} {{ action.assignedTo.lastName }}</span>
                            {% if action.dueDate %}
                            <span class="due-date">Due: {{ action.dueDate|date('M d, Y') }}</span>
                            {% endif %}
                            <span class="status {{ action.status }}">{{ action.status|title }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {% elseif retrospective.isCompleted() %}
        <!-- Completed Retrospective -->
        <div class="completed-retrospective">
            <h2>Retrospective Completed</h2>
            <p>This retrospective was completed on {{ retrospective.completedAt|date('M d, Y H:i') }}</p>
            
            <!-- Show summary of all feedback and actions -->
            <div class="summary-sections">
                <div class="summary-section">
                    <h3>Feedback Summary</h3>
                    <div class="feedback-summary">
                        <div class="summary-column">
                            <h4>What went wrong ({{ wrongItems|length }})</h4>
                            {% for item in wrongItems %}
                            <div class="summary-item">{{ item.content }}</div>
                            {% endfor %}
                        </div>
                        <div class="summary-column">
                            <h4>What went good ({{ goodItems|length }})</h4>
                            {% for item in goodItems %}
                            <div class="summary-item">{{ item.content }}</div>
                            {% endfor %}
                        </div>
                        <div class="summary-column">
                            <h4>What can be improved ({{ improvedItems|length }})</h4>
                            {% for item in improvedItems %}
                            <div class="summary-item">{{ item.content }}</div>
                            {% endfor %}
                        </div>
                        <div class="summary-column">
                            <h4>Random feedback ({{ randomItems|length }})</h4>
                            {% for item in randomItems %}
                            <div class="summary-item">{{ item.content }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {% if actions|length > 0 %}
                <div class="summary-section">
                    <h3>Action Items ({{ actions|length }})</h3>
                    <div class="actions-summary">
                        {% for action in actions %}
                        <div class="action-summary">
                            <strong>{{ action.description }}</strong><br>
                            Assigned to: {{ action.assignedTo.firstName }} {{ action.assignedTo.lastName }}<br>
                            Status: {{ action.status|title }}
                            {% if action.dueDate %}
                            <br>Due: {{ action.dueDate|date('M d, Y') }}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {% else %}
        <!-- Planned Retrospective -->
        <div class="retrospective-planned">
            <div class="planned-message">
                <h3>This retrospective is planned</h3>
                <p>It will be available once the facilitator starts the session.</p>
                {% if retrospective.facilitator == app.user %}
                <a href="{{ path('app_retrospectives_start', {'id': retrospective.id}) }}" class="btn btn-primary">
                    Start Retrospective
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        window.retrospectiveId = {{ retrospective.id }};
        window.isFacilitator = {{ retrospective.facilitator == app.user ? 'true' : 'false' }};
        console.log('Template script executed');
        console.log('window.retrospectiveId:', window.retrospectiveId);
        console.log('window.isFacilitator:', window.isFacilitator);
    </script>
    
    <!-- Floating Timer -->
    <div class="floating-timer" id="floatingTimer" {% if retrospective.isInStep('actions') %}style="display: none;"{% endif %}>
        {% if retrospective.facilitator == app.user %}
        <div class="timer-label" style="font-size: 0.8rem; font-weight: bold; color: #6c757d; margin-bottom: 0.5rem; text-align: center;">Set timer</div>
        <div class="timer-controls">
            <input type="number" id="timerDuration" value="10" min="1" max="60" class="timer-input">
            <span style="font-size: 0.8rem;">min</span>
            <button id="startTimerBtn" class="btn btn-primary" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" title="Start Timer">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            </button>
        </div>
        {% endif %}
        <div id="timerDisplay" class="timer-display" style="display: none;">
            <span id="timerTime">10:00</span>
            <span class="timer-label" style="font-size: 0.8rem; display: inline-block; color: #6c757d;">remaining</span>
            {% if retrospective.facilitator == app.user %}
            <button id="stopTimerBtn" class="stop-timer-btn" title="Stop Timer">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="6" y="6" width="12" height="12" rx="2"/>
                </svg>
            </button>
            {% endif %}
        </div>
        <div id="timerStopped" class="timer-stopped-message" style="display: none;">
            <span style="font-size: 0.9rem; font-weight: bold; color: #6c757d;">Timer stopped</span>
        </div>
    </div>
    
    <script src="{{ asset('assets/js/retrospective-board.js') }}"></script>
    <script src="{{ asset('assets/js/voting-system.js') }}"></script>
    
    <!-- Temporary: Test voting button -->
    <script>
        // Add a test button to start voting
        document.addEventListener('DOMContentLoaded', function() {
            if (window.retrospectiveBoard) {
                // Create test button
                const testBtn = document.createElement('button');
                testBtn.textContent = 'Start Voting (Test)';
                testBtn.className = 'btn btn-success';
                testBtn.style.cssText = 'position: fixed; bottom: 20px; left: 20px; z-index: 1001;';
                testBtn.addEventListener('click', () => {
                    window.retrospectiveBoard.initVoting();
                });
                document.body.appendChild(testBtn);
            }
        });
    </script>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">
                <div class="confirm-modal-icon">!</div>
                <h3 class="confirm-modal-title" id="confirmModalTitle">Confirm Action</h3>
            </div>
            <div class="confirm-modal-body" id="confirmModalBody">
                Are you sure you want to proceed?
            </div>
            <div class="confirm-modal-footer">
                <button class="confirm-modal-btn confirm-modal-btn-cancel" id="confirmModalCancel">Cancel</button>
                <button class="confirm-modal-btn confirm-modal-btn-confirm" id="confirmModalConfirm">Confirm</button>
            </div>
        </div>
    </div>
{% endblock %}