<!-- Action Description -->
<div class="action-detail-group">
    <label class="action-detail-label">Description</label>
    <div class="action-description-detail">
        <div class="action-description-view" id="modal-view-{{ action.id }}" onclick="editModalActionDescription({{ action.id }})">
            {{ action.description }}
        </div>
        <div class="action-description-edit" id="modal-edit-{{ action.id }}" style="display: none;">
            <textarea class="action-edit-textarea" rows="4" id="modal-text-{{ action.id }}">{{ action.description }}</textarea>
            <div class="action-edit-actions">
                <button class="btn btn-sm btn-success save-action-btn" onclick="saveModalActionDescription({{ action.id }})">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Save Changes
                </button>
                <button class="btn btn-sm btn-secondary cancel-action-btn" onclick="cancelModalActionDescription({{ action.id }})">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assignee Information -->
<div class="action-detail-group">
    <label class="action-detail-label">Assigned To</label>
    <div class="assignee-view" id="modal-assignee-view-{{ action.id }}" onclick="editModalAssignee({{ action.id }})">
        {% if action.assignedTo %}
            <div class="action-assignee-detail">
                <div class="action-assignee-avatar">
                    {{ action.assignedTo.email|slice(0,1)|upper }}
                </div>
                <div class="action-assignee-info">
                    <div class="action-assignee-name">{{ action.assignedTo.email }}</div>
                    <div class="action-assignee-role">
                        {% if action.retrospective.team.owner == action.assignedTo %}
                            Team Owner
                        {% else %}
                            Team Member
                        {% endif %}
                    </div>
                </div>
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20" style="margin-left: 8px;">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </div>
        {% else %}
            <div style="color: #9ca3af; font-style: italic; padding: 1rem; background: #f9fafb; border-radius: 8px; display: flex; align-items: center;">
                No one assigned to this action
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20" style="margin-left: 8px;">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </div>
        {% endif %}
    </div>
    <div class="assignee-edit-form" id="modal-assignee-edit-{{ action.id }}" style="display: none;">
        <select class="assignee-select" id="modal-assignee-select-{{ action.id }}" data-original-value="{{ action.assignedTo ? action.assignedTo.id : '' }}">
            <option value="">No one assigned</option>
            {% for member in action.retrospective.team.teamMembers %}
                <option value="{{ member.user.id }}" {{ action.assignedTo == member.user ? 'selected' : '' }}>
                    {{ member.user.email }}
                </option>
            {% endfor %}
            {# Include team owner if not in team members #}
            {% if action.retrospective.team.owner not in action.retrospective.team.teamMembers|map(member => member.user) %}
                <option value="{{ action.retrospective.team.owner.id }}" {{ action.assignedTo == action.retrospective.team.owner ? 'selected' : '' }}>
                    {{ action.retrospective.team.owner.email }} (Owner)
                </option>
            {% endif %}
        </select>
        <button class="btn btn-sm btn-secondary" onclick="saveModalAssignee({{ action.id }})">
            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
            </svg>
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="cancelModalAssignee({{ action.id }})">
            <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
        </button>
    </div>
</div>

<!-- Context Information -->
{% if contextData %}
<div class="action-detail-group">
    <label class="action-detail-label">Context</label>
    <div class="context-info context-{{ contextData.data.category }}">
        {% if contextData.type == 'item' %}
            <div class="context-card">
                <div class="context-content">{{ contextData.data.content }}</div>
            </div>
        {% elseif contextData.type == 'group' %}
            <div class="context-group">
                <div class="context-items">
                    {% for item in contextData.data.items %}
                        <div class="context-item">
                            <div class="context-content">{{ item.content }}</div>
                        </div>
                        {% if not loop.last %}<div class="item-separator"></div>{% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Action Metadata -->
<div class="action-metadata">
    <div class="action-metadata-item">
        <div class="label">Status</div>
        <div class="value">
            <div class="status-badge-view" id="modal-status-view-{{ action.id }}" onclick="editModalActionStatus({{ action.id }})">
                <span class="status-badge {{ action.status }}">
                    {{ action.status|replace({'-': ' '})|title }}
                </span>
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20" style="margin-left: 4px;">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="status-edit-form" id="modal-status-edit-{{ action.id }}" style="display: none;">
                <select class="status-select" id="modal-status-select-{{ action.id }}" onchange="saveModalActionStatus({{ action.id }})">
                    <option value="pending" {{ action.status == 'pending' ? 'selected' : '' }}>Pending</option>
                    <option value="in-progress" {{ action.status == 'in-progress' ? 'selected' : '' }}>In Progress</option>
                    <option value="completed" {{ action.status == 'completed' ? 'selected' : '' }}>Completed</option>
                    <option value="cancelled" {{ action.status == 'cancelled' ? 'selected' : '' }}>Cancelled</option>
                </select>
                <button class="btn btn-sm btn-secondary cancel-status-btn" onclick="cancelModalActionStatus({{ action.id }})">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div class="action-metadata-item">
        <div class="label">Due Date</div>
        <div class="value">
            <div class="due-date-view" id="modal-due-date-view-{{ action.id }}" onclick="editModalDueDate({{ action.id }})">
                {% if action.dueDate %}
                    <span>{{ action.dueDate|date('l, F j, Y') }}</span>
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20" style="margin-left: 4px;">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                    </svg>
                {% else %}
                    <span style="color: #9ca3af;">No due date set</span>
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20" style="margin-left: 4px;">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                    </svg>
                {% endif %}
            </div>
            <div class="due-date-edit-form" id="modal-due-date-edit-{{ action.id }}" style="display: none;">
                <input type="date" class="due-date-input" id="modal-due-date-input-{{ action.id }}" 
                       value="{{ action.dueDate ? action.dueDate|date('Y-m-d') : '' }}"
                       data-original-value="{{ action.dueDate ? action.dueDate|date('Y-m-d') : '' }}">
                <button class="btn btn-sm btn-secondary" onclick="saveModalDueDate({{ action.id }})">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="cancelModalDueDate({{ action.id }})">
                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>


    <div class="action-metadata-item">
        <div class="label">From Retrospective</div>
        <div class="value">
            <a href="{{ path('app_retrospectives_show', {'id': action.retrospective.id}) }}" 
               class="retrospective-link"
               target="_blank">
                {{ action.retrospective.title }}
                <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20" style="margin-left: 4px;">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </a>
        </div>
    </div>

    {% if action.completedAt %}
    <div class="action-metadata-item">
        <div class="label">Completed At</div>
        <div class="value">{{ action.completedAt|date('M d, Y H:i') }}</div>
    </div>
    {% endif %}
</div>

<!-- Modal Footer -->
<div class="action-modal-footer">
    {% if not action.isReviewed %}
        <button class="btn btn-primary mark-reviewed-btn" onclick="markAsReviewed({{ action.id }})">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
            Mark as Reviewed
        </button>
    {% else %}
        <div class="reviewed-status">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20" style="color: #10b981;">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
            </svg>
            Reviewed
        </div>
    {% endif %}
</div>

<style>
/* Action Description Styles */
.action-description-view {
    font-style: normal !important;
    font-weight: normal;
    color: #374151;
    line-height: 1.5;
}

.action-description-detail {
    font-style: normal !important;
}

.status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.status-badge.pending {
    background: #64748b;
    color: white;
}

.status-badge.open {
    background: #ff6b6b;
    color: white;
}

.status-badge.in-progress {
    background: #ffd93d;
    color: #744210;
}

.status-badge.completed {
    background: #6bcf7f;
    color: white;
}

.status-badge.cancelled {
    background: #94a3b8;
    color: white;
}

.retrospective-link {
    display: inline-flex;
    align-items: center;
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
}

.retrospective-link:hover {
    color: #5a67d8;
    text-decoration: underline;
}

.retrospective-link svg {
    transition: transform 0.2s ease;
}

.retrospective-link:hover svg {
    transform: translateX(2px);
}

/* Context Styles */
.context-info {
    background: #f9fafb;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #e5e7eb;
    margin-top: 0.5rem;
    position: relative;
    overflow: hidden;
}

.context-info.context-wrong {
    border-left-color: #ef4444;
    background: #fef2f2;
}

.context-info.context-good {
    border-left-color: #10b981;
    background: #f0fdf4;
}

.context-info.context-improved {
    border-left-color: #f59e0b;
    background: #fffbeb;
}

.context-info.context-random {
    border-left-color: #8b5cf6;
    background: #faf5ff;
}

.context-card {
    margin-bottom: 0;
}

.context-content {
    font-size: 0.875rem;
    line-height: 1.5;
    color: #374151;
    margin-bottom: 0.75rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

.context-meta {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    font-size: 0.75rem;
    color: #6b7280;
}

.context-category {
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.context-author {
    font-style: italic;
}

.context-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.context-count {
    font-size: 0.75rem;
    color: #6b7280;
    background: #e5e7eb;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}

.context-items {
    /* space-y handled by individual item margins */
}

.context-item {
    margin-bottom: 1rem;
}

.context-item:last-child {
    margin-bottom: 0;
}



/* Prevent any floating text */
.context-info * {
    position: relative;
    z-index: 1;
}

/* Ensure no text appears outside the container */
.context-info::before,
.context-info::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: 0;
}

/* Modal Footer Styles */
.action-modal-footer {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    align-items: center;
}

.mark-reviewed-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.mark-reviewed-btn:hover {
    background: #5a67d8;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.reviewed-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: #f0fdf4;
    color: #10b981;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
}
</style>