{% extends 'base.html.twig' %}

{% block title %}Teams{% endblock %}

{% block page_title %}Teams{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css/team-management.css') }}">
    <style>
        /* Force red color for organization message */
        .text-danger {
            color: #dc3545 !important;
        }
        
        /* Force right alignment for header actions */
        .header-actions {
            align-items: flex-end !important;
        }
        
        /* Ensure text alignment for error message */
        .header-actions .text-end {
            text-align: right !important;
        }
    </style>
{% endblock %}

{% block body %}
    <div class="team-management">
        <!-- Header Section -->
        <div class="team-header">
            <div class="header-content">
                <h1>My Teams</h1>
                <p>Manage your teams and collaborate with your colleagues</p>
            </div>
            <div class="header-actions d-flex flex-column align-items-end">
                {% if app.user.hasRole('ROLE_ADMIN') or app.user.hasRole('ROLE_SUPERVISOR') or app.user.hasRole('ROLE_FACILITATOR') %}
                    {% set hasOrganization = false %}
                    {% for membership in app.user.organizationMemberships %}
                        {% if membership.isActive and membership.leftAt is null %}
                            {% set hasOrganization = true %}
                        {% endif %}
                    {% endfor %}
                    {% if not hasOrganization %}
                        {% for ownedOrg in app.user.ownedOrganizations %}
                            {% set hasOrganization = true %}
                        {% endfor %}
                    {% endif %}
                    
                    <a href="{{ path('app_teams_create') }}" class="btn btn-primary">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                        </svg>
                        Create New Team
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- Teams Overview -->
        <div class="teams-overview">
            <div class="stats-card">
                <div class="stats-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                    </svg>
                </div>
                <div class="stats-content">
                    <h3>{{ ownedTeams|length + memberTeams|length }}</h3>
                    <p>Total Teams</p>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="stats-content">
                    <h3>{{ ownedTeams|length }}</h3>
                    <p>Teams I Own</p>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-icon">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="stats-content">
                    <h3>{{ memberTeams|length }}</h3>
                    <p>Teams I'm In</p>
                </div>
            </div>
        </div>

        <!-- Owned Teams Section -->
        {% if ownedTeams|length > 0 %}
        <div class="teams-section">
            <div class="section-header">
                <h2>Teams I Own</h2>
                <p>Teams where you are the owner</p>
            </div>
            <div class="teams-grid">
                {% for team in ownedTeams %}
                <div class="team-card owned">
                    <div class="team-header">
                        <div class="team-info">
                            <h3>{{ team.name }}</h3>
                            {% if team.description %}
                                <p>{{ team.description }}</p>
                            {% endif %}
                        </div>
                        <div class="team-color" style="background-color: {{ team.color ?: '#667eea' }}"></div>
                    </div>
                    <div class="team-stats">
                        <div class="stat">
                            <span class="stat-number">{{ team.getMemberCount() }}</span>
                            <span class="stat-label">Members</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number">{{ team.createdAt|date('M d') }}</span>
                            <span class="stat-label">Created</span>
                        </div>
                    </div>
                    <div class="team-actions">
                        <a href="{{ path('app_teams_show', {'id': team.id}) }}" class="btn btn-sm btn-primary">
                            View Team
                        </a>
                        <a href="{{ path('app_teams_edit', {'id': team.id}) }}" class="btn btn-sm btn-secondary">
                            Edit
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Member Teams Section -->
        {% if memberTeams|length > 0 %}
        <div class="teams-section">
            <div class="section-header">
                <h2>Teams I'm In</h2>
                <p>Teams where you are a member</p>
            </div>
            <div class="teams-grid">
                {% for team in memberTeams %}
                <div class="team-card member">
                    <div class="team-header">
                        <div class="team-info">
                            <h3>{{ team.name }}</h3>
                            {% if team.description %}
                                <p>{{ team.description }}</p>
                            {% endif %}
                        </div>
                        <div class="team-color" style="background-color: {{ team.color ?: '#667eea' }}"></div>
                    </div>
                    <div class="team-stats">
                        <div class="stat">
                            <span class="stat-number">{{ team.getMemberCount() }}</span>
                            <span class="stat-label">Members</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number">{{ member.role ?: 'Member' }}</span>
                            <span class="stat-label">Your Role</span>
                        </div>
                    </div>
                    <div class="team-actions">
                        <a href="{{ path('app_teams_show', {'id': team.id}) }}" class="btn btn-sm btn-primary">
                            View Team
                        </a>
                        <a href="{{ path('app_teams_leave', {'id': team.id}) }}" 
                           class="btn btn-sm btn-danger"
                           onclick="return confirm('Are you sure you want to leave this team?')">
                            Leave
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Empty State -->
        {% if ownedTeams|length == 0 and memberTeams|length == 0 %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg width="64" height="64" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                </svg>
            </div>
            <h3>No teams yet</h3>
            <p>Create your first team to start collaborating with your colleagues</p>
            {% if app.user.hasRole('ROLE_ADMIN') or app.user.hasRole('ROLE_SUPERVISOR') or app.user.hasRole('ROLE_FACILITATOR') %}
                {% set hasOrganization = false %}
                {% for membership in app.user.organizationMemberships %}
                    {% if membership.isActive and membership.leftAt is null %}
                        {% set hasOrganization = true %}
                    {% endif %}
                {% endfor %}
                {% if not hasOrganization %}
                    {% for ownedOrg in app.user.ownedOrganizations %}
                        {% set hasOrganization = true %}
                    {% endfor %}
                {% endif %}
                
                <a href="{{ path('app_teams_create') }}" class="btn btn-primary">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                    Create Your First Team
                </a>
                {% if not hasOrganization %}
                    <div class="text-danger mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        You must be part of an organization to create teams.
                    </div>
                {% endif %}
            {% else %}
                <p class="text-muted">Only Administrators, Supervisors, and Facilitators can create teams.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endblock %}