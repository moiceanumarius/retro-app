{% set routeName = app.request.get('_route_name') %}

{# Check if page_title variable is passed from template #}
{% set customTitle = page_title is defined ? page_title : null %}

{# Mapping of route names to display titles #}
{% set titleMapping = {
    'app_dashboard': 'Dashboard',
    'app_home': 'Dashboard', 
    'app_login': 'Login',
    'app_logout': 'Logout',
    'app_register': 'Register',
    'app_verify_email': 'Email Verification',
    'app_user_profile_edit': 'Edit Profile',
    'app_user_profile': 'User Profile',
    'app_user_change_password': 'Change Password',
    'app_teams_create': 'Create Team',
    'app_teams_edit': 'Edit Team',
    'app_teams_show': 'Team Details',
    'app_teams': 'Teams',
    'app_teams_add_member': 'Add Team Member',
    'app_teams_remove_member': 'Remove Team Member',
    'app_teams_leave': 'Leave Team',
    'app_teams_delete': 'Delete Team',
    'app_teams_create_invitation': 'Create Team Invitation',
    'app_team_invitation_show': 'Team Invitation',
    'app_team_invitation_accept': 'Accept Invitation',
    'app_team_invitation_decline': 'Decline Invitation',
    'app_team_retrospectives': 'Team Retrospectives',
    'app_retrospectives_create': 'Create Retrospective',
    'app_retrospectives_edit': 'Edit Retrospective',
    'app_retrospectives_show': 'Retrospective',
    'app_retrospectives': 'Retrospectives',
    'app_retrospectives_start': 'Start Retrospective',
    'app_retrospectives_complete': 'Complete Retrospective',
    'app_retrospectives_add_item': 'Add Item',
    'app_retrospectives_add_action': 'Add Action',
    'app_retrospectives_start_timer': 'Start Timer',
    'app_retrospectives_update_item_ajax': 'Update Item',
    'app_retrospectives_vote': 'Voting',
    'app_actions_team_selection': 'Actions Management',
    'app_actions_index': 'Actions',
    'app_actions_by_team': 'Team Actions',
    'app_actions_details': 'Action Details',
    'app_actions_edit_description': 'Edit Action',
    'app_actions_update_status': 'Update Status',
    'app_actions_update_due_date': 'Update Due Date',
    'app_actions_update_assignee': 'Update Assignee',
    'app_organizations': 'Organizations',
    'app_organizations_create': 'Create Organization',
    'app_organizations_edit': 'Edit Organization',
    'app_organizations_show': 'Organization Details',
    'app_organizations_delete': 'Delete Organization',
    'app_organizations_reactivate': 'Reactivate Organization',
    'app_organizations_add_member': 'Add Member',
    'app_organizations_remove_member': 'Remove Member',
    'app_organizations_show_members': 'Organization Members',
    'app_organizations_search': 'Search Organizations',
    'app_roles': 'Roles Management',
    'app_roles_assign': 'Assign Roles',
    'app_roles_remove': 'Remove Role',
    'app_roles_data': 'Role Data'
} %}

{# Determine the title based on custom title, route mapping, or fallback #}
{% set pageTitle = customTitle ?? titleMapping[routeName] ?? 'Dashboard' %}

{# For route names not in mapping, try to extract meaningful name #}
{% if pageTitle == 'Dashboard' and routeName %}
    {% set routeParts = routeName|split('_') %}
    {% if routeParts|length >= 2 %}
        {% set controllerName = routeParts[1] %}
        {% set actionName = routeParts|length >= 3 ? routeParts[2] : 'index' %}
        
        {% if controllerName == 'roles' %}
            {% set pageTitle = actionName == 'assign' ? 'Assign Roles' : 'Roles Management' %}
        {% elseif controllerName == 'teams' %}
            {% if actionName == 'create' %}{% set pageTitle = 'Create Team' %}
            {% elseif actionName == 'edit' %}{% set pageTitle = 'Edit Team' %}
            {% elseif actionName == 'show' %}{% set pageTitle = 'Team Details' %}
            {% elseif actionName == 'members' %}{% set pageTitle = 'Team Members' %}
            {% else %}{% set pageTitle = 'Teams' %}
            {% endif %}
        {% elseif controllerName == 'retrospectives' %}
            {% if actionName == 'create' %}{% set pageTitle = 'Create Retrospective' %}
            {% elseif actionName == 'edit' %}{% set pageTitle = 'Edit Retrospective' %}
            {% elseif actionName == 'show' %}{% set pageTitle = 'Retrospective' %}
            {% else %}{% set pageTitle = 'Retrospectives' %}
            {% endif %}
        {% elseif controllerName == 'actions' %}
            {% if actionName == 'create' %}{% set pageTitle = 'Create Action' %}
            {% elseif actionName == 'edit' %}{% set pageTitle = 'Edit Action' %}
            {% elseif actionName == 'team_selection' %}{% set pageTitle = 'Actions Management' %}
            {% else %}{% set pageTitle = 'Actions' %}
            {% endif %}
        {% elseif controllerName == 'organizations' %}
            {% if actionName == 'create' %}{% set pageTitle = 'Create Organization' %}
            {% elseif actionName == 'edit' %}{% set pageTitle = 'Edit Organization' %}
            {% elseif actionName == 'show' %}{% set pageTitle = 'Organization Details' %}
            {% elseif actionName == 'add_member' %}{% set pageTitle = 'Add Member' %}
            {% elseif actionName == 'show_members' %}{% set pageTitle = 'Organization Members' %}
            {% else %}{% set pageTitle = 'Organizations' %}
            {% endif %}
        {% else %}
            {# Generic fallback - capitalize the controller name #}
            {% set pageTitle = controllerName|title %}
        {% endif %}
    {% endif %}
{% endif %}

<!-- Content Header -->
<header class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 class="content-title">{{ pageTitle }}</h1>
        
        <div style="display: flex; align-items: center; gap: 1rem;">
            {% if app.user %}
                <div class="user-welcome-section">
                    <div class="user-info">
                        <div class="user-avatar">
                            {% if app.user.avatar %}
                                <img src="{{ asset('uploads/avatars/' ~ app.user.avatar) }}" alt="Avatar" class="avatar-img">
                            {% else %}
                                <div class="avatar-placeholder">
                                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                            {% endif %}
                        </div>
                        <div class="user-details">
                            <div class="user-name">
                                {{ app.user.firstName }} {{ app.user.lastName }}
                            </div>
                            <div class="user-organization">
                                {% set userOrganization = null %}
                                {% for membership in app.user.organizationMemberships %}
                                    {% if membership.isActive and membership.leftAt is null %}
                                        {% set userOrganization = membership.organization %}
                                    {% endif %}
                                {% endfor %}
                                {% if userOrganization %}
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 4px;">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 1h2v2H7V5zm8 8v2h1v-2h-1zm-2-2h2v2h-2v-2zm0-3h2v2h-2V8zm0-3h2v2h-2V5zm-3 3h2v2h-2V8zm0-3h2v2h-2V5zm0-3h2v2h-2V2zM7 8h2v2H7V8zm0-3h2v2H7V5zm0-3h2v2H7V2z" clip-rule="evenodd"></path>
                                    </svg>
                                    {{ userOrganization.name }}
                                {% else %}
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20" style="margin-right: 4px;">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    No Organization
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Mobile sidebar toggle -->
            <button id="sidebar-toggle" class="btn btn-secondary" style="display: none;">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </div>
</header>
